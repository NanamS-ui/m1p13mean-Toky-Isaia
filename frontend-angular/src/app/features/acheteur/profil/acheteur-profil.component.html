<div class="profil-page">
  <div class="profil-card">
    @if (loading()) {
      <div class="profil-loading">
        <span class="material-symbols-outlined">progress_activity</span>
        <p>Chargement du profil...</p>
      </div>
    }
    <!-- Profile Header -->
    <div class="profil-header">
      <div class="profil-avatar">
        <span class="avatar-initials">{{ getInitials() }}</span>
      </div>
      <div class="profil-info">
        <h1 class="profil-name">{{ userProfile().firstName }} {{ userProfile().lastName }}</h1>
        <p class="profil-email">
          <span class="material-symbols-outlined">email</span>
          {{ userProfile().email }}
        </p>
      </div>
    </div>

    <!-- Tab Navigation -->
    <div class="tab-navigation">
      <button 
        type="button"
        class="tab-btn"
        [class.tab-btn--active]="activeTab() === 'personal'"
        (click)="activeTab.set('personal')">
        <span class="material-symbols-outlined">person</span>
        Informations personnelles
      </button>
      <button 
        type="button"
        class="tab-btn"
        [class.tab-btn--active]="activeTab() === 'addresses'"
        (click)="activeTab.set('addresses')">
        <span class="material-symbols-outlined">location_on</span>
        Adresse
      </button>
      <button 
        type="button"
        class="tab-btn"
        [class.tab-btn--active]="activeTab() === 'security'"
        (click)="activeTab.set('security')">
        <span class="material-symbols-outlined">lock</span>
        Sécurité
      </button>
    </div>

    <!-- Tab Content -->
    <div class="tab-content">
      <!-- Personal Info Tab -->
      @if (activeTab() === 'personal') {
        <div class="tab-panel">
          <h2 class="tab-panel__title">Informations personnelles</h2>
          <form [formGroup]="personalInfoForm" (ngSubmit)="onSavePersonalInfo()" class="profil-form">
            @if (saveSuccess()) {
              <div class="alert alert--success">
                <span class="material-symbols-outlined">check_circle</span>
                Profil mis à jour avec succès
              </div>
            }
            @if (saveError()) {
              <div class="alert alert--error">
                <span class="material-symbols-outlined">error</span>
                {{ saveError() }}
              </div>
            }
            <div class="form-group">
              <label for="firstName">Prénom</label>
              <input 
                id="firstName" 
                type="text" 
                formControlName="firstName" 
                placeholder="Votre prénom"
                [class.error]="personalInfoForm.get('firstName')?.invalid && personalInfoForm.get('firstName')?.touched" />
              @if (personalInfoForm.get('firstName')?.invalid && personalInfoForm.get('firstName')?.touched) {
                <span class="error-text">
                  @if (personalInfoForm.get('firstName')?.errors?.['required']) {
                    Le prénom est requis
                  } @else if (personalInfoForm.get('firstName')?.errors?.['minlength']) {
                    Le prénom doit contenir au moins 2 caractères
                  }
                </span>
              }
            </div>

            <div class="form-group">
              <label for="lastName">Nom</label>
              <input 
                id="lastName" 
                type="text" 
                formControlName="lastName" 
                placeholder="Votre nom"
                [class.error]="personalInfoForm.get('lastName')?.invalid && personalInfoForm.get('lastName')?.touched" />
              @if (personalInfoForm.get('lastName')?.invalid && personalInfoForm.get('lastName')?.touched) {
                <span class="error-text">
                  @if (personalInfoForm.get('lastName')?.errors?.['required']) {
                    Le nom est requis
                  } @else if (personalInfoForm.get('lastName')?.errors?.['minlength']) {
                    Le nom doit contenir au moins 2 caractères
                  }
                </span>
              }
            </div>

            <div class="form-group">
              <label for="email">Email</label>
              <input 
                id="email" 
                type="email" 
                formControlName="email" 
                placeholder="votre.email@example.mg"
                [class.error]="personalInfoForm.get('email')?.invalid && personalInfoForm.get('email')?.touched" />
              @if (personalInfoForm.get('email')?.invalid && personalInfoForm.get('email')?.touched) {
                <span class="error-text">
                  @if (personalInfoForm.get('email')?.errors?.['required']) {
                    L'email est requis
                  } @else if (personalInfoForm.get('email')?.errors?.['email']) {
                    Format d'email invalide
                  }
                </span>
              }
            </div>

            <div class="form-group">
              <label for="phone">Téléphone</label>
              <input 
                id="phone" 
                type="tel" 
                formControlName="phone" 
                placeholder="+261 34 12 345 67"
                [class.error]="personalInfoForm.get('phone')?.invalid && personalInfoForm.get('phone')?.touched" />
              @if (personalInfoForm.get('phone')?.invalid && personalInfoForm.get('phone')?.touched) {
                <span class="error-text">Le numéro de téléphone est requis</span>
              }
            </div>

            <button type="submit" class="btn btn--primary" [disabled]="personalInfoForm.invalid">
              <span class="material-symbols-outlined">save</span>
              Enregistrer les modifications
            </button>
          </form>
        </div>
      }

      <!-- Adresse Tab (modèle backend : champ unique) -->
      @if (activeTab() === 'addresses') {
        <div class="tab-panel">
          <h2 class="tab-panel__title">Mon adresse</h2>
          <form [formGroup]="adresseForm" (ngSubmit)="onSaveAdresse()" class="profil-form">
            @if (addressSaveSuccess()) {
              <div class="alert alert--success">
                <span class="material-symbols-outlined">check_circle</span>
                Adresse mise à jour avec succès
              </div>
            }
            @if (addressSaveError()) {
              <div class="alert alert--error">
                <span class="material-symbols-outlined">error</span>
                {{ addressSaveError() }}
              </div>
            }
            <div class="form-group">
              <label for="adresse">Adresse complète</label>
              <textarea 
                id="adresse" 
                formControlName="adresse" 
                placeholder="Ex: Lot II M 12 Bis Ambohimanarina, Antananarivo 101, Madagascar"
                rows="3"
                class="form-textarea"></textarea>
            </div>
            <button type="submit" class="btn btn--primary">
              <span class="material-symbols-outlined">save</span>
              Enregistrer l'adresse
            </button>
          </form>
        </div>
      }

      <!-- Security Tab -->
      @if (activeTab() === 'security') {
        <div class="tab-panel">
          <h2 class="tab-panel__title">Changer le mot de passe</h2>
          <form [formGroup]="passwordForm" (ngSubmit)="onChangePassword()" class="profil-form">
            @if (passwordSaveSuccess()) {
              <div class="alert alert--success">
                <span class="material-symbols-outlined">check_circle</span>
                Mot de passe modifié avec succès
              </div>
            }
            @if (passwordSaveError()) {
              <div class="alert alert--error">
                <span class="material-symbols-outlined">error</span>
                {{ passwordSaveError() }}
              </div>
            }
            <div class="form-group">
              <label for="currentPassword">Mot de passe actuel</label>
              <input 
                id="currentPassword" 
                type="password" 
                formControlName="currentPassword" 
                placeholder="••••••••"
                [class.error]="passwordForm.get('currentPassword')?.invalid && passwordForm.get('currentPassword')?.touched" />
              @if (passwordForm.get('currentPassword')?.invalid && passwordForm.get('currentPassword')?.touched) {
                <span class="error-text">Le mot de passe actuel est requis</span>
              }
            </div>

            <div class="form-group">
              <label for="newPassword">Nouveau mot de passe</label>
              <input 
                id="newPassword" 
                type="password" 
                formControlName="newPassword" 
                placeholder="••••••••"
                [class.error]="passwordForm.get('newPassword')?.invalid && passwordForm.get('newPassword')?.touched" />
              @if (passwordForm.get('newPassword')?.invalid && passwordForm.get('newPassword')?.touched) {
                <span class="error-text">
                  @if (passwordForm.get('newPassword')?.errors?.['required']) {
                    Le nouveau mot de passe est requis
                  } @else if (passwordForm.get('newPassword')?.errors?.['minlength']) {
                    Le mot de passe doit contenir au moins 6 caractères
                  }
                </span>
              }
            </div>

            <div class="form-group">
              <label for="confirmPassword">Confirmer le nouveau mot de passe</label>
              <input 
                id="confirmPassword" 
                type="password" 
                formControlName="confirmPassword" 
                placeholder="••••••••"
                [class.error]="(passwordForm.get('confirmPassword')?.invalid || passwordForm.errors?.['passwordMismatch']) && passwordForm.get('confirmPassword')?.touched" />
              @if (passwordForm.get('confirmPassword')?.invalid && passwordForm.get('confirmPassword')?.touched) {
                <span class="error-text">La confirmation du mot de passe est requise</span>
              }
              @if (passwordForm.errors?.['passwordMismatch'] && passwordForm.get('confirmPassword')?.touched) {
                <span class="error-text">Les mots de passe ne correspondent pas</span>
              }
            </div>

            <button type="submit" class="btn btn--primary" [disabled]="passwordForm.invalid">
              <span class="material-symbols-outlined">lock</span>
              Changer le mot de passe
            </button>
          </form>
        </div>
      }
    </div>
  </div>
</div>
