<div class="carte-page">
  <div class="carte-header">
    <h1>
      <span class="material-symbols-outlined">map</span>
      Carte interactive
    </h1>
    <p class="carte-header__subtitle">Explorez le centre commercial et trouvez vos boutiques</p>
  </div>

  @if (loading()) {
    <div class="carte-loading">
      <span class="material-symbols-outlined">progress_activity</span>
      <p>Chargement de la carte...</p>
    </div>
  } @else if (error()) {
    <div class="carte-error">
      <span class="material-symbols-outlined">error</span>
      <p>{{ error() }}</p>
      <button class="btn btn--primary" (click)="loadData()">Réessayer</button>
    </div>
  } @else {
  <div class="carte-content">
    <!-- Sidebar -->
    <div class="carte-sidebar">
      <!-- Floor Selector -->
      <div class="sidebar-section">
        <h3>
          <span class="material-symbols-outlined">layers</span>
          Niveaux
        </h3>
        <div class="floor-selector">
          @for (floor of floors(); track floor._id) {
            <button
              class="floor-btn"
              [class.floor-btn--active]="selectedFloorId() === floor._id"
              (click)="setFloor(floor._id)"
            >
              <span class="material-symbols-outlined">stairs</span>
              {{ floor.value }}
            </button>
          }
          @empty {
            <p class="empty-text">Aucun niveau</p>
          }
        </div>
      </div>

      <!-- Search -->
      <div class="sidebar-section">
        <h3>
          <span class="material-symbols-outlined">search</span>
          Rechercher
        </h3>
        <div class="search-box">
          <span class="material-symbols-outlined">search</span>
          <input
            type="text"
            placeholder="Nom de la boutique..."
            [ngModel]="searchQuery()"
            (ngModelChange)="searchQuery.set($event)"
            class="search-input"
          />
          @if (searchQuery()) {
            <button class="search-clear" type="button" (click)="searchQuery.set('')">
              <span class="material-symbols-outlined">close</span>
            </button>
          }
        </div>
      </div>

      <!-- Filters -->
      <div class="sidebar-section">
        <h3>
          <span class="material-symbols-outlined">tune</span>
          Filtres
        </h3>
        <div class="filters">
          <div class="filter-group">
            <label>Catégorie</label>
            <div class="category-chips">
              @for (cat of categoriesWithAll(); track cat._id) {
                <button
                  type="button"
                  class="category-chip"
                  [class.category-chip--active]="(selectedCategoryId() || '') === (cat._id || '')"
                  (click)="setCategory(cat._id ? cat._id : null)"
                >
                  <span class="material-symbols-outlined">category</span>
                  {{ cat.value }}
                </button>
              }
            </div>
          </div>

          <div class="filter-group">
            <label class="checkbox-label">
              <input
                type="checkbox"
                [checked]="showOpenOnly()"
                (change)="showOpenOnly.set($any($event.target).checked)"
                class="checkbox-input"
              />
              <span class="checkbox-custom"></span>
              <span class="checkbox-text">
                <span class="material-symbols-outlined">schedule</span>
                Ouvertes maintenant
              </span>
            </label>
          </div>

          @if (searchQuery() || selectedCategoryId() || showOpenOnly()) {
            <button type="button" class="btn-clear-filters" (click)="clearFilters()">
              <span class="material-symbols-outlined">clear_all</span>
              Réinitialiser
            </button>
          }
        </div>
      </div>

      <!-- Legend -->
      <div class="sidebar-section">
        <h3>
          <span class="material-symbols-outlined">info</span>
          Légende
        </h3>
        <div class="legend">
          @for (cat of categories(); track cat._id) {
            <div class="legend-item">
              <span
                class="legend-marker"
                [style.background-color]="getCategoryColor(cat.value)"
              ></span>
              <span class="legend-label">{{ cat.value }}</span>
            </div>
          }
          @empty {
            <p class="empty-text">Aucune catégorie</p>
          }
        </div>
      </div>

      <!-- Shop List -->
      <div class="sidebar-section">
        <h3>
          <span class="material-symbols-outlined">store</span>
          Boutiques ({{ filteredShops().length }})
        </h3>
        <div class="shop-list">
          @if (filteredShops().length === 0) {
            <div class="empty-shops">
              <span class="material-symbols-outlined">search_off</span>
              <p>Aucune boutique trouvée</p>
            </div>
          } @else {
            @for (shop of filteredShops(); track shop.id) {
              <button
                type="button"
                class="shop-list-item"
                [class.shop-list-item--active]="selectedShop()?.id === shop.id"
                [class.shop-list-item--closed]="!shop.isOpen"
                (click)="selectShop(shop)"
              >
                <div class="shop-list-marker" [style.background-color]="getCategoryColor(shop.category)"></div>
                <div class="shop-list-info">
                  <h4>{{ shop.name }}</h4>
                  <p>
                    <span class="material-symbols-outlined">location_on</span>
                    {{ shop.doorValue }} · {{ shop.floorLabel }}
                    @if (!shop.isOpen) {
                      <span class="status-closed">Fermé</span>
                    } @else {
                      <span class="status-open">Ouvert</span>
                    }
                  </p>
                </div>
                <span class="material-symbols-outlined">chevron_right</span>
              </button>
            }
          }
        </div>
      </div>
    </div>

    <!-- Map Area -->
    <div class="carte-map-area">
      <div class="map-container">
        <div class="map-background">
          <!-- Plan d'étage : Allée A, Allée B, couloir central -->
          <svg class="floor-plan-svg" viewBox="0 0 100 100" preserveAspectRatio="none">
            <defs>
              <pattern id="floor-pattern" width="4" height="4" patternUnits="userSpaceOnUse">
                <rect width="4" height="4" fill="none" stroke="rgba(148,163,184,0.15)" stroke-width="0.3"/>
              </pattern>
              <linearGradient id="corridor-grad" x1="0%" y1="0%" x2="100%" y2="0%">
                <stop offset="0%" stop-color="#f8fafc"/>
                <stop offset="100%" stop-color="#f1f5f9"/>
              </linearGradient>
            </defs>
            <rect x="2" y="5" width="96" height="88" fill="var(--korus-card-bg)" stroke="var(--korus-border)" stroke-width="0.5" rx="1"/>
            <rect x="44" y="8" width="12" height="82" fill="url(#corridor-grad)" stroke="rgba(148,163,184,0.3)" stroke-width="0.4"/>
            <path d="M 40 88 L 40 93 L 60 93 L 60 88 Z" fill="var(--korus-accent-dim)" stroke="var(--korus-accent)" stroke-width="0.5"/>
            <rect x="6" y="8" width="8" height="6" fill="rgba(148,163,184,0.2)" stroke="rgba(148,163,184,0.4)" stroke-width="0.3" rx="0.5"/>
            <rect x="86" y="8" width="8" height="6" fill="rgba(148,163,184,0.2)" stroke="rgba(148,163,184,0.4)" stroke-width="0.3" rx="0.5"/>
            <rect x="4" y="18" width="36" height="66" fill="url(#floor-pattern)" stroke="rgba(148,163,184,0.25)" stroke-width="0.3" rx="0.5"/>
            <text x="22" y="24" font-size="2.2" fill="var(--korus-text-muted)" font-weight="600">Allée A</text>
            <rect x="60" y="18" width="36" height="66" fill="url(#floor-pattern)" stroke="rgba(148,163,184,0.25)" stroke-width="0.3" rx="0.5"/>
            <text x="78" y="24" font-size="2.2" fill="var(--korus-text-muted)" font-weight="600">Allée B</text>
          </svg>

          <div class="entrance-marker" [class.entrance-marker--route]="showRoute() && routeFromEntrance()">
            <span class="material-symbols-outlined">door_front</span>
            <span class="entrance-label">Entrée</span>
          </div>

          @if (showRoute() && selectedShop() && routeFromEntrance()) {
            <svg class="route-line" viewBox="0 0 100 100" preserveAspectRatio="none">
              <line
                x1="50"
                y1="92"
                [attr.x2]="selectedShop()!.x"
                [attr.y2]="selectedShop()!.y"
                stroke="var(--korus-accent)"
                stroke-width="2"
                stroke-dasharray="4 4"
                marker-end="url(#arrowhead)"
              />
              <defs>
                <marker id="arrowhead" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
                  <polygon points="0 0, 10 3, 0 6" fill="var(--korus-accent)" />
                </marker>
              </defs>
            </svg>
          }

          @for (shop of filteredShops(); track shop.id) {
            <button
              type="button"
              class="shop-marker"
              [class.shop-marker--selected]="selectedShop()?.id === shop.id"
              [class.shop-marker--closed]="!shop.isOpen"
              [style.left.%]="shop.x"
              [style.top.%]="shop.y"
              [style.--marker-color]="getCategoryColor(shop.category)"
              (click)="selectShop(shop)"
              [title]="shop.name"
            >
              <span class="material-symbols-outlined">{{ getCategoryIcon(shop.category) }}</span>
              @if (shop.isOpen) {
                <span class="marker-pulse"></span>
              }
            </button>
          }
        </div>

        <div class="floor-label">
          <span class="material-symbols-outlined">layers</span>
          {{ selectedFloorLabel() }}
        </div>
      </div>

      @if (selectedShop()) {
        <div class="shop-popup">
          <button type="button" class="popup-close" (click)="closeShopPopup()">
            <span class="material-symbols-outlined">close</span>
          </button>
          <div class="popup-header">
            <div
              class="popup-icon"
              [style.background-color]="getCategoryColor(selectedShop()!.category)"
            >
              <span class="material-symbols-outlined">{{ getCategoryIcon(selectedShop()!.category) }}</span>
            </div>
            <div class="popup-title">
              <h3>{{ selectedShop()!.name }}</h3>
              <div class="popup-status">
                @if (selectedShop()!.isOpen) {
                  <span class="status-badge status-badge--open">
                    <span class="material-symbols-outlined">check_circle</span>
                    Ouvert
                  </span>
                } @else {
                  <span class="status-badge status-badge--closed">
                    <span class="material-symbols-outlined">cancel</span>
                    Fermé
                  </span>
                }
              </div>
            </div>
          </div>
          <div class="popup-body">
            <div class="popup-info">
              <div class="info-item">
                <span class="material-symbols-outlined">location_on</span>
                <div>
                  <strong>Emplacement:</strong>
                  <p>Porte {{ selectedShop()!.doorValue }} · {{ selectedShop()!.floorLabel }}</p>
                </div>
              </div>
              <div class="info-item">
                <span class="material-symbols-outlined">category</span>
                <div>
                  <strong>Catégorie:</strong>
                  <p>{{ selectedShop()!.category }}</p>
                </div>
              </div>
              @if (selectedShop()!._raw.description) {
                <div class="info-item">
                  <span class="material-symbols-outlined">info</span>
                  <div>
                    <strong>Description:</strong>
                    <p>{{ selectedShop()!._raw.description }}</p>
                  </div>
                </div>
              }
            </div>
            <div class="popup-actions">
              <a
                [routerLink]="['/acheteur/boutiques', selectedShop()!.id]"
                class="btn-primary"
              >
                <span class="material-symbols-outlined">store</span>
                Voir la boutique
              </a>
              <button
                type="button"
                class="btn-secondary"
                (click)="toggleRoute()"
              >
                <span class="material-symbols-outlined">directions</span>
                {{ showRoute() ? 'Masquer' : 'Afficher' }} l'itinéraire
              </button>
            </div>
          </div>
        </div>
      }
    </div>
  </div>
  }
</div>
